## 説明
NHK 語学講座で放送された番組の音声を、NHK の聞き逃し配信サービスを利用して取得し、ファイルに保存します。

## 動作の概要
番組の音声データの取得は 2 つのステップに分けて行います。この 2 つのステップで特定の語学講座番組の特定の放送回の音声データがダウンロードされます。
ステップ 1 では「放送回情報取得 URL」にアクセスして放送回ごとの「音声ファイル名」を取得します。これには後述の「番組パス」が必要となります。
ステップ 2 では、ステップ 1 で得た音声ファイル名を使って「音声データダウンロード URL」にアクセスし、放送回ごとに音声データをダウンロードします。

ステップ 1：音声ファイル名の取得
音声ファイル名は放送回情報取得 URL にアクセスして取得します。どの語学講座番組の音声ファイル名を取得するかは「番組パス」を指定することで決めることができます。
放送回情報取得 URL の形式は次の通りです。

```
    放送回情報取得 URL
    https://cgi2.nhk.or.jp/gogaku/st/xml/<番組パス>/listdataflv.xml
```

これにより、放送回ごとの音声ファイル名が得られます。

ステップ 2：音声データのダウンロード
音声データのダウンロードは、音声データダウンロード URL にアクセスすることで行います。1 回のアクセスで 1 つの放送回の音声データをダウンロードすることができます。
ステップ 1 で取得した音声ファイル名を使い、音声データダウンロード URL を構成します。

```
    音声データダウンロード URL
    https://nhks-vh.akamaihd.net/i/gogaku-stream/mp4/<音声ファイル名>/master.m3u8
```

聞き逃し配信サービスでは過去のすべての放送回を取得できるわけではありません。すべての放送回の番組音声を取得したい場合は、両方の URL に少なくとも毎週 1 回アクセスする必要があります。

## 動作説明
### 1. 音声ファイル名を取得するために、ダウンロードできるレッスン回の一覧を取得します。
「ラジオ英会話」の各レッスン回を取得する場合で説明します。
「ラジオ英会話」の番組パスは "english/kaiwa" なので、放送回情報取得 URL は次のようになります。

```
    放送回情報取得 URL
    https://cgi2.nhk.or.jp/gogaku/st/xml/english/kaiwa/listdataflv.xml
```

### 2. 上記の放送回情報 URL にアクセスするとこんな XML データが得られます（内容は毎週変わります）。

```
<?xml version="1.0" encoding="UTF-8"?>
<musicdata>
<music title="ラジオ英会話" hdate="11月25日放送分" kouza="ラジオ英会話" code="4235810" file="19-er-4235-810.mp4" nendo="2019" pgcode="F0"></music>
<music title="ラジオ英会話" hdate="11月26日放送分" kouza="ラジオ英会話" code="4235811" file="19-er-4235-811.mp4" nendo="2019" pgcode="F0"></music>
<music title="ラジオ英会話" hdate="11月27日放送分" kouza="ラジオ英会話" code="4235812" file="19-er-4235-812.mp4" nendo="2019" pgcode="F0"></music>
<music title="ラジオ英会話" hdate="11月28日放送分" kouza="ラジオ英会話" code="4235813" file="19-er-4235-813.mp4" nendo="2019" pgcode="F0"></music>
<music title="ラジオ英会話" hdate="11月29日放送分" kouza="ラジオ英会話" code="4235814" file="19-er-4235-814.mp4" nendo="2019" pgcode="F0"></music>
</musicdata>
```

<music> 要素の file="" 属性に格納されているのが音声ファイル名です。
上記 XML データによると「ラジオ英会話」2019年度11月25日放送分のファイル名は 19-er-4235-810.mp4 なので、この放送回の音声データダウンロード URL は次のようになります。

```
    音声データダウンロード URL
    https://nhks-vh.akamaihd.net/i/gogaku-stream/mp4/19-er-4235-810.mp4/master.m3u8
```

### 3. 上記の音声データダウンロード URL にアクセスすると「ラジオ英会話」2019年度11月25日放送分の音声データが得られます。
音声データのダウンロードと MP3 形式への変換には ffmpeg コマンドを次のように呼び出して行っています。こうすると、ffmpeg コマンドは音声データダウンロード URL から音声データをダウンロードして MP3 形式に変換してファイルに保存してくれます（ffmpeg 最強説）。

```
    ffmpeg -i https://nhks-vh.akamaihd.net/i/gogaku-stream/mp4/19-er-4235-810.mp4/master.m3u8 -c:a mp3 ラジオ英会話_2019年度_11月25日放送分.mp3
    （ここでは拡張子に .mp3 を指定しているので -c:a mp3 はなくてもよい）
```

## 番組パスの調べ方

「番組パス」は、どの語学講座番組かを表す文字列で、各番組ページの URL を見ると分かります。
例えば、「ラジオ英会話」の番組ページは、

https://www2.nhk.or.jp/gogaku/english/kaiwa/

なので、「ラジオ英会話」の番組パスは english/kaiwa であると分かります。

以下の URL に各語学講座番組の番組へのリンクがありますので、それぞれの語学講座番組の番組パスを調べるのに便利です。

https://www.nhk.or.jp/radio/ondemand/index_genre.html?g=genre11

